<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>tRPG Playaid : Lady Blackbird</title>
    <meta name="description" content="playaids for Lady Blackbird built with Javascript">
    <meta name="author" content="brushmen">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- custom CSS -->
    <style>
    body {
        background-color: black;
    }

    div.tooltip-inner {
        max-width: 600px;
        max-height: 600px;
    }
    .tooltip.show {
        opacity: 1!important;
    }

    #playArea {
        display: none;
    }

    .full-height {
        height: 100vh;
        background-color: #233040;
    }

    #gmArea {
        color: rgb(220, 217, 205);
        background-color: black;
    }

    #blackbirdArea {
        color: #38085c;
        background-color: #7e6aaf;
    }

    #bishopArea {
        color: #972d1d;
        background-color: #fbdcc8;
    }

    #vanceArea {
        color: #081c63;
        background-color: #aec5e4;
    }

    #arkamArea {
        color: #C0C0C0;
        background-color: #7F462C;
    }

    #snargleArea {
        color: #016c3b;
        background-color: #64c095;
    }

    #diceArea {
        text-align: center;
        color: rgb(220, 217, 205);
    }

    #resultArea {
        text-align: center;
        font-size: 2em;
        font-weight: bolder;
        color: black;
        background-color: rgb(220, 217, 205);
    }

    #chatArea {
        background-color: rgb(220, 217, 205);
    }

    #chatSection {
        height: 150px;
        overflow-y: scroll;
    }

    #chat {

    }

    .block {
        margin: 3px 5px;
    }

    li.no-decoration {
        background: transparent;
        border-width: 0px;
    }

    .trait, .key, .secret {
        cursor: help;
    }

    .dicepool {
        font-size: 1.2em;
        cursor: help;
    }

    .xp {
        font-size: 1.2em;
        cursor: help;
    }

    .difficulty {
        font-weight: bold;
        color: red;
    }

    .portrait {
        width: 93px;
        height: 150px;
        padding-top: 5px;
        font-size: 12pt;
    }

    .locked {
        pointer-events: none;
        opacity: 0.8;
    }

    .inactive {
        poiter-events: none;
        opacity: 0.2;
    }

    .fainter {
        opacity: 0.7;
    }

    .top-right-corner {
        position: relative;
    }

    .bwToggle {
        position: absolute;
        top: 0;
        right: 0;
        cursor: pointer;
        margin: 0;
        padding: 0;
        width: 20px;
        height: 20px;
        color: rgb(220, 217, 205);
    }

    .lorelistToggle {
        position: absolute;
        top: 0;
        right: 30px;
        cursor: pointer;
        margin: 0;
        padding: 0;
        width: 20px;
        height: 20px;
    }

    #lorelist {
        position: absolute;
        top: 0px;
        left: 0px;
        z-index: 2;
        cursor: grab;
        display: none;
        width: 800px;
        font-size: 1em;
    }
    #lorelistDetails {
        height: 600px;
        overflow: auto;
    }

    .cornerClick {
        position: absolute;
        top: 0px;
        right: 5px;
        cursor: pointer;
        opacity: 0.5;
    }

    #charSheet {
        position: absolute;
        top: 0px;
        left: 0px;
        z-index: 2;
        cursor: grab;
        display: none;
        width: 700px;
        font-size: 1em;
    }
    #charSheetDetails {
        height: 600px;
        overflow: auto;
    }

    .clickable {
        cursor: pointer;
    }

    .indented {
        text-indent: 40px;
    }

    .tags {
        font-style: italic;
    }

    #loadbox {
        position: absolute;
        top: 0;
        left: 0;
        width: 600px;
        overflow: auto;
        z-index: 3;
    }
    #loadboxjson {
        width: 600px;
        height: 300px;
    }
    </style>
</head>

<body>
    <!-- hovering elements -->
    <div id="charSheet" style="display: none" class="card">
        <h5 class="card-header">Character Info</h5>
        <div class="cornerClick" onclick="$('#charSheet').hide();">hide</div>
        <div class="card-body" id="charSheetDetails"></div>
    </div>
    <div id="lorelist" style="display: none" class="card">
        <h5 class="card-header">Setting Overview</h5>
        <div class="cornerClick" onclick="$('#lorelist').hide();">hide</div>
        <div class="card-body" id="lorelistDetails"></div>
    </div>
    <div id="loadbox" style="display: none" class="card">
        <h5 class="card-header">load JSON content</h5>
        <div class="cornerClick" onclick="$('#loadbox').hide();">hide</div>
        <textarea id="loadboxjson" placeholder="JSON only"></textarea>
        <button type="submit" class="btn btn-sm btn-warning">send</button>
    </div>


    <!-- main content -->
    <div class="container-fluid">

        <div id="roleArea">
            <div class="row full-height">
                <div class="col justify-content-center align-self-center">
                    <div class="row justify-content-center">
                        <form id="roleForm">
                            <ul>
                                <li class="list-group-item no-decoration"><input type="submit" id="chooseBlackbird" name="blackbird" class="btn btn-info btn-lg" disabled="disabled" value="Lady Blackbird"></li>
                                <li class="list-group-item no-decoration"><input type="submit" id="chooseBishop" name="bishop" class="btn btn-info btn-lg" disabled="disabled" value="N. Bishop"></li>
                                <li class="list-group-item no-decoration"><input type="submit" id="chooseVance"  name="vance" class="btn btn-info btn-lg" disabled="disabled" value="C. Vance"></li>
                                <li class="list-group-item no-decoration"><input type="submit"  id="chooseArkam" name="arkam" class="btn btn-info btn-lg" disabled="disabled" value="K. Arkam"></li>
                                <li class="list-group-item no-decoration"><input type="submit"  id="chooseSnargle"name="snargle" class="btn btn-info btn-lg" disabled="disabled" value="Snargle"></li>
                                <li class="list-group-item no-decoration"><input type="submit" name="gm" id="chooseGM" class="btn btn-info btn-lg" disabled="disabled" value="Game Master"></li>
                            </ul>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="playArea">
            <div class="row full-height">
                <div class="col justify-content-center align-self-center">
                    <div class="row">
                        <div id="gmArea" class="col-4 my-col">
                            <div class="top-right-corner">
                                <div class="lorelistToggle" onclick="loreListToggle();">üìã</div>
                                <div class="bwToggle" onclick="bwContrastToggle();">‚ó©</div>
                            </div>
                            <strong>Game Master</strong>
                            &nbsp;
                            üîó <span class="block" id="totalConnections"></span>
                            üë§ <span class="block" id="totalRoles"></span>
                            <div class="row" style="margin-top: 10px">
                                <div class="col" id="difficultyArea">
                                    Difficulty:
                                    <button class="btn btn-dark btn-sm" onclick="setDifficulty(3);">3</button>
                                    <button class="btn btn-dark btn-sm" onclick="setDifficulty(4);">4</button>
                                    <button class="btn btn-dark btn-sm" onclick="setDifficulty(5);">5</button>
                                </div>
                                <div class="col" id="refreshDicePools">
                                    <button class="btn btn-dark btn-sm" id="refreshDicePools" onclick="refreshDicePools();">refresh dice pools</button>
                                </div>
                            </div>
                            <div class="row block" style="margin-top: 5px" id="owlConditions">
                                <a href="http://www.onesevendesign.com/ladyblackbird" target="_new" title="Lady Blackbird is a game by John Harper">ü¶â</a> The Owl needs &nbsp;
                                <span title="fuel">üíß <input type="checkbox" id="needFuel"/></span>
                                &nbsp;&nbsp;
                                <span title="supplies">üçï <input type="checkbox" id="needSupplies"/></span>
                                &nbsp;&nbsp;
                                <span title="repairs">üîß <input type="checkbox" id="needRepairs"/></span>
                                &nbsp;&nbsp;
                                <span title="speed">üöÄ <input type="checkbox" id="needSpeed"/></span>
                            </div>
                            <div class="portraits">
                                <img src="" id="portraitBlackbird" class="portrait" data-toggle="tooltip" alt="image for Lady Blackbird" onclick="portraitURL('blackbird');" title="" />
                                <img src="" id="portraitBishop" class="portrait" data-toggle="tooltip" alt="image for Bishop" onclick="portraitURL('bishop');" title="" />
                                <img src="" id="portraitVance" data-toggle="tooltip" class="portrait" alt="image for Vance" onclick="portraitURL('vance');" title="" />
                                <img src="" id="portraitArkam" data-toggle="tooltip" class="portrait" data-placement="right" alt="image for Arkam" onclick="portraitURL('arkam');" title="" />
                                <img src="" id="portraitSnargle" data-toggle="tooltip" class="portrait" alt="image for Snargle" onclick="portraitURL('snargle');" title="" />
                                <input type="submit" id="portraitURL" hidden="true"/>
                            </div>
                        </div>
                        <div id="blackbirdArea" class="col-4 my-col">
                            <div class="text-center clickable" onclick="showCharSheet('blackbird');"><strong><span title="stormblood">üå©</span> Lady Blackbird | Natasha Syri <span title="swordswoman">‚öî</span></strong></div>
                            <div class="row justify-content-center" id="blackbirdConditions">
                                <span title="injured">üíâ <input type="checkbox" id="injuredBlackbird"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="dead">üíÄ <input type="checkbox" id="deadBlackbird"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="tired">üí§ <input type="checkbox" id="tiredBlackbird"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="angry">üò° <input type="checkbox" id="angryBlackbird"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="lost">üîÑ <input type="checkbox" id="lostBlackbird"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="hunted">üéØ <input type="checkbox" id="huntedBlackbird"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="trapped">üö∑ <input type="checkbox" id="trappedBlackbird"/></span>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="block" id="traitsBlackbird"></div>
                                </div>
                                <div class="col justify-content-center">
                                    <div class="block" id="keysBlackbird"></div>
                                    <div class="block" id="secretsBlackbird"></div>
                                </div>
                            </div>
                            <div class="row locked" id="blackbirdButtons">
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolBlackbirdReward" onclick="dicePoolReward('blackbird');">+1</button>
                                </div>
                                <div class="col">
                                    <div id="dicePoolBlackbird" title="max of 10"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolBlackbirdHelping" onclick="dicePoolHelping('blackbird');">helping</button>
                                </div>
                                <div class="col">
                                    <div id="xpBlackbird" title="spend 5 to advance"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="xpBlackbirdReward" onclick="xpReward('blackbird');">+1</button>
                                </div>
                            </div>
                        </div>

                        <div id="bishopArea" class="col-4 my-col">
                            <div class="text-center clickable" onclick="showCharSheet('bishop');"><strong><span title="fighter">üëä</span> N. Bishop <span title="knightly">‚ôû</span></strong></div>
                            <div class="row justify-content-center" id="bishopConditions">
                                <span title="injured">üíâ <input type="checkbox" id="injuredBishop"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="dead">üíÄ <input type="checkbox" id="deadBishop"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="tired">üí§ <input type="checkbox" id="tiredBishop"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="angry">üò° <input type="checkbox" id="angryBishop"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="lost">üîÑ <input type="checkbox" id="lostBishop"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="hunted">üéØ <input type="checkbox" id="huntedBishop"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="trapped">üö∑ <input type="checkbox" id="trappedBishop"/></span>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="block" id="traitsBishop"></div>
                                </div>
                                <div class="col justify-content-center">
                                    <div class="block" id="keysBishop"></div>
                                    <div class="block" id="secretsBishop"></div>
                                </div>
                            </div>
                            <div class="row locked" id="bishopButtons">
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolBishopReward" onclick="dicePoolReward('bishop');">+1</button>
                                </div>
                                <div class="col">
                                    <div id="dicePoolBishop" title="max of 10"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolBishopHelping" onclick="dicePoolHelping('bishop');">helping</button>
                                </div>
                                <div class="col">
                                    <div id="xpBishop" title="spend 5 to advance"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="xpBishopReward" onclick="xpReward('bishop');">+1</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row ">
                        <div id="diceArea" class="col-5 align-self-center">
                            <form id="diceForm">
                                1+
                                <select id="actionDice" name="actionDice">                                    <option value="0" selected="selected">action dice</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                </select>
                                +
                                <select id="poolDice" name="poolDice">
                                    <option value="0" selected="selected">pool dice</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                                +
                                help x
                                <span id="helpingDice">0</span>
                                &nbsp;&nbsp;
                                <input type="submit" class="btn btn-info" id="rollDice" value="roll">
                                <span id="difficulty"></span>
                            </form>
                        </div>
                        <div class="col-3 align-self-top">
                            <div class="row justify-content-center" id="resultArea">roll result</div>
                            <div class="row justify-content-center align-self-center" style="margin-top: 40px">
                                <button type="submit" class="btn btn-light btn-sm" onclick="raiseHand();">Raise Hand</button>
                                &nbsp;&nbsp;
                                <button type="submit" class="btn btn-secondary btn-sm" onclick="xcard();">X-CARD</button>
                                &nbsp;&nbsp;
                                <button type="submit" class="btn btn-link btn-sm" onclick="clearResultArea();">clear</button>
                            </div>
                        </div>
                        <div id="chatArea" class="col-4 my-col">
                            <div class="row">
                                <form id="messageForm" class="container-fluid">
                                    <div id="chatSection">
                                        <!-- the chatSection has a set height
                                            but the chat obj has a dynamically
                                            changing height, otherwise scroll-to-bottom
                                            won't work -->
                                        <div class="chat" id="chat"></div>
                                    </div>
                                    <div class="input-group">
                                        <input type="text" class="form-control width100" id="message" placeholder="chat" />
                                        <span class="input-group-btn">
                                            <input type="submit" class="btn btn-info" value="send" />
                                        </span>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                    <div class="row ">
                        <div id="arkamArea" class="col-4 my-col">
                            <div class="text-center clickable" onclick="showCharSheet('arkam');"><strong><span title="mechanic">üîß</span> K. Arkam <span title="greedy">ü§ë</span></strong></div>
                            <div class="row justify-content-center" id="arkamConditions">
                                <span title="injured">üíâ <input type="checkbox" id="injuredArkam"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="dead">üíÄ <input type="checkbox" id="deadArkam"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="tired">üí§ <input type="checkbox" id="tiredArkam"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="angry">üò° <input type="checkbox" id="angryArkam"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="lost">üîÑ <input type="checkbox" id="lostArkam"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="hunted">üéØ <input type="checkbox" id="huntedArkam"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="trapped">üö∑ <input type="checkbox" id="trappedArkam"/></span>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="block" id="traitsArkam"></div>
                                </div>
                                <div class="col justify-content-center">
                                    <div class="block" id="keysArkam"></div>
                                    <div class="block" id="secretsArkam"></div>
                                </div>
                            </div>
                            <div class="row locked" id="arkamButtons">
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolArkamReward" onclick="dicePoolReward('arkam');">+1</button>
                                </div>
                                <div class="col">
                                    <div id="dicePoolArkam" title="max of 10"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolArkamHelping" onclick="dicePoolHelping('arkam');">helping</button>
                                </div>
                                <div class="col">
                                    <div id="xpArkam" title="spend 5 to advance"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="xpArkamReward" onclick="xpReward('arkam');">+1</button>
                                </div>
                            </div>
                        </div>

                        <div id="vanceArea" class="col-4 my-col">
                            <div class="text-center clickable" onclick="showCharSheet('vance');"><strong><span title="navigator">‚åö</span> C. Vance <span title="secretive">üïµ</span></strong></div>
                            <div class="row justify-content-center" id="vanceConditions">
                                <span title="injured">üíâ <input type="checkbox" id="injuredVance"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="dead">üíÄ <input type="checkbox" id="deadVance"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="tired">üí§ <input type="checkbox" id="tiredVance"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="angry">üò° <input type="checkbox" id="angryVance"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="lost">üîÑ <input type="checkbox" id="lostVance"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="hunted">üéØ <input type="checkbox" id="huntedVance"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="trapped">üö∑ <input type="checkbox" id="trappedVance"/></span>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="block" id="traitsVance"></div>
                                </div>
                                <div class="col justify-content-center">
                                    <div class="block" id="keysVance"></div>
                                    <div class="block" id="secretsVance"></div>
                                </div>
                            </div>
                            <div class="row locked" id="vanceButtons">
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolVanceReward" onclick="dicePoolReward('vance');">+1</button>
                                </div>
                                <div class="col">
                                    <div id="dicePoolVance" title="max of 10"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolVanceHelping" onclick="dicePoolHelping('vance');">helping</button>
                                </div>
                                <div class="col">
                                    <div id="xpVance" title="spend 5 to advance"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="xpVanceReward" onclick="xpReward('vance');">+1</button>
                                </div>
                            </div>
                        </div>

                        <div id="snargleArea" class="col-4 my-col">
                            <div class="text-center clickable" onclick="showCharSheet('snargle');"><strong><span title="lucky">üçÄ</span> Snargle <span title="compassionate">üíñ</span></strong></div>
                            <div class="row justify-content-center" id="snargleConditions">
                                <span title="injured">üíâ <input type="checkbox" id="injuredSnargle"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="dead">üíÄ <input type="checkbox" id="deadSnargle"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="tired">üí§ <input type="checkbox" id="tiredSnargle"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="angry">üò° <input type="checkbox" id="angrySnargle"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="lost">üîÑ <input type="checkbox" id="lostSnargle"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="hunted">üéØ <input type="checkbox" id="huntedSnargle"/></span>
                                &nbsp;&nbsp;&nbsp;
                                <span title="trapped">üö∑ <input type="checkbox" id="trappedSnargle"/></span>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="block" id="traitsSnargle"></div>
                                </div>
                                <div class="col justify-content-center">
                                    <div class="block" id="keysSnargle"></div>
                                    <div class="block" id="secretsSnargle"></div>
                                </div>
                            </div>
                            <div class="row locked" id="snargleButtons">
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolSnargleReward" onclick="dicePoolReward('snargle');">+1</button>
                                </div>
                                <div class="col">
                                    <div id="dicePoolSnargle" title="max of 10"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="dicePoolSnargleHelping" onclick="dicePoolHelping('snargle');">helping</button>
                                </div>
                                <div class="col">
                                    <div id="xpSnargle" title="spend 5 to advance"></div>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-outline-dark btn-sm" id="xpSnargleReward" onclick="xpReward('snargle');">+1</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap template script includes -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script src="/socket.io/socket.io.js"></script>

    <!-- Javascript code -->
    <script>
        var infotext = {};
        infotext['Paragon'] = "As a noble, you're a cut above the common man. Hit your key when you demonstrate your superiority or when your noble traits overcome a problem. Buyoff: Disown your noble heritage.";
        infotext['Mission'] = "You must escape the Empire and rendezvous with your once secret lover, the Pirate King Uriah Flint, whom you haven't seen in six years. Hit your key when you take action to complete the mission. Buyoff: Give up on your mission.";
        infotext['Impostor'] = "You are in disguise, passing yourself off as commoner. Hit your key when you perform well enough to fool someone with your disguise. Buyoff: Reveal your true identity to someone you fooled.";
        infotext['Guardian'] = "You are Lady Blackbird's loyal defender. Hit your key when you make a decision influenced by Lady Blackbird or protect her from harm. Buyoff: Sever your relationship with the Lady.";
        infotext['Vengeance'] = "The Empire enslaved you and made you kill for sport. You will have your revenge on them and watch their cities burn. Hit your key when you strike a blow against the Empire (especially by killing an Imperial). Buyoff: Forgive them for what they did to you.";
        infotext['Warrior'] = "You crave the crash and roar of battle, the tougher the better. Hit your key when you do battle with worthy or superior foes. Buyoff: Pass up an opportunity for a good fight.";
        infotext['Commander'] = "You are accustomed to giving orders and having them obeyed. Hit your trait when you come up with a plan and give orders to make it happen. Buyoff: Acknowledge someone else as the leader.";
        infotext['Hidden Longing'] = "You are completely enthralled by Lady Blackbird, but you don't want her to know it. Hit your key when you make a decision based on this secret affection or when you somehow show it indirectly. Buyoff: Give up on your secret desire or make it public.";
        infotext['Outcast'] = "You got exiled from the Empire. Hit your key when your outcast status causes you trouble or is important in a scene. Buyoff: Regain your former standing or join a new group.";
        infotext['Greed'] = "You like the shiny things. Hit your key when you steal something cool or score a big payoff. Buyoff: Swear off stealing forever.";
        infotext['Job'] = "You must safely deliver Lady Blackbird to the Pirate King Uriah Flint, so she can marry him. Hit your key when you take action to complete the mission. Buyoff: Give up the mission.";
        infotext['Fraternity'] = "You are sworn to Captain Vance in a bond of brotherhood. Hit your key when your character is influenced by Vance or when you show how deep your bond is. Buyoff: Sever the relationship";
        infotext['Daredevil'] = "You thrive in dangerous situations. Hit your key when you do something cool that is risky or reckless (especially piloting stunts). Buyoff: Be very very careful.";
        infotext['Conscience'] = "You don't like to see anyone suffer, even enemies. Hit your key when you help someone who is in trouble or when you change someone's life for the better Buyoff: Ignore a request for help.";
        infotext['Banter'] = "You have a knack for snappy comments. Hit your key when Snargle says something that makes the other players laugh or when you explain something using your pilot techno jargon. Buyoff: Everyone groans at one of your comments.";

        infotext['Stormblood'] = "As long as you can speak, you can channel magical power and do Sorcery. You have the Master Sorcerer trait and the Stormblood tag.";
        infotext['Inner Focus'] = "Once per session, you can re-roll a failure when doing Sorcery.";
        infotext['Destruction'] = "You can break things with your bare hands as if you were swinging a sledgehammer. It's scary.";
        infotext['Bodyguard'] = "Once per session, you can re-roll a failure when protecting someone.";
        infotext['Leadership'] = "Once per session, you can give someone else a chance to re-roll a failed roll, by giving them orders, advice, or setting a good example.";
        infotext['Warpblood'] = "Once per session, you can teleport yourself or someone you're touching.";
        infotext['Concealment'] = "No matter how thoroughly you're searched, you always have a few key items with you. You can produce any common, simple item at a moment's notice.";
        infotext['Reflexes'] = "Once per session, you can re-roll a failure when doing anything involving grace, dexterity, or quick reflexes.";
        infotext['Shape Warping'] = "As a goblin, you can change your shape, growing shorter, taller, fatter, thinner, or changing your skin color, at will.";
        infotext['Lucky Break'] = "Once per session, you can keep your pool dice when you succeed (so go ahead and use ‚Äòem all).";
        var portraits = {
            'blackbird': "",
            'bishop': "",
            'vance': "",
            'arkam': "",
            'snargle': ""
        };
        var dicepool = {blackbird: 7, bishop: 7, vance: 7, arkam: 7, snargle: 7};
        var xp = {blackbird: 0, bishop: 0, vance: 0, arkam: 0, snargle: 0};
        var role = '';
        var difficulty = 0;
        var socket = io.connect();

        $(function() {
            var $messageForm = $('#messageForm');
            var $message = $('#message');
            var $chat = $('#chat');
            var $playArea = $('#playArea');
            var $messageArea = $('#messageArea');
            var $roleArea = $('#roleArea');
            var $roleForm = $('#roleForm');
            var submitRole = null;
            var $submitRoles = $roleForm.find('input[type=submit]');
            var activeRoles = new Array();
            var $totalConnections = $('#totalConnections');
            var $totalRoles = $('#totalRoles');
            var $diceForm = $('#diceForm');
            var $actionDice = $('#actionDice');
            var $poolDice = $('#poolDice');
            var $helpingDice = $('#helpingDice');
            var $resultArea = $('#resultArea');
            var $gmArea = $('#gmArea');
            var $blackbirdArea = $('#blackbirdArea');
            var $bishopArea = $('#bishopArea');
            var $vanceArea = $('#vanceArea');
            var $arkamArea = $('#arkamArea');
            var $snargleArea = $('#snargleArea');

            // prepare element effects

            dragElement(document.getElementById("charSheet"));
            dragElement(document.getElementById("lorelist"));

            $submitRoles.click(function(e) {
                submitRole = this;
                // disable that button, so another user cannot pick that role
                $(this).prop('disabled',true);
            });

            $('#chooseBlackbird').click(function(e) {
                chooseRole(e);
            });
            $('#chooseBishop').click(function(e) {
                chooseRole(e);
            });
            $('#chooseVance').click(function(e) {
                chooseRole(e);
            });
            $('#chooseArkam').click(function(e) {
                chooseRole(e);
            });
            $('#chooseSnargle').click(function(e) {
                chooseRole(e);
            });
            $('#chooseGM').click(function(e) {
                chooseRole(e);
            });

            function chooseRole(e) {
                e.preventDefault();
                if (submitRole == null) {
                    // If no role is explicitly clicked, the browser will
                    // automatically choose the first in source-order
                    submitRole = $submitRoles[0];
                }
                role = submitRole.name;

                $message.prop('placeholder', role);
                socket.emit('choose role', role, function(data) {
                    $roleArea.hide();
                    $playArea.show();
                    updatePortraits();
                });
            }

            socket.on('get roles', function(data) {
                var n = '';
                activeRoles = data.msg;
                if (activeRoles.length > 0) {
                    for (var i = 0; i < $submitRoles.length; i++) {
                        if (activeRoles.includes($submitRoles[i].name)) {
                            //  disable buttons for active roles
                            $($submitRoles[i]).prop('disabled',true);
                            $('#' + $submitRoles[i].name + 'Area').removeClass('inactive');
                        }
                        else {
                            // re-enable buttons for released roles
                            $($submitRoles[i]).prop('disabled',false);
                            $('#' + $submitRoles[i].name + 'Area').addClass('inactive');
                        }
                    }

                    var html = '';
                    var tagstr = '';

                    for (var i = 0; i < $submitRoles.length; i++) {
                        n = $submitRoles[i].name;
                        if (n != role) {
                            $('#' + n + 'Area').addClass('fainter');
                            $('#' + n + 'Buttons').addClass('locked');
                            $('#difficultyArea').addClass('locked');
                            $('#refreshDicePools').addClass('locked');
                            $('#owlConditions').addClass('locked');
                        }
                        else  {
                            $('#' + n + 'Area').removeClass('fainter');
                            $('#' + n + 'Buttons').removeClass('locked');
                        }
                    }

                    // GM can access everything
                    if (role == 'gm') {
                        $('#difficultyArea').removeClass('locked');
                        $('#refreshDicePools').removeClass('locked');
                        $('#owlConditions').removeClass('locked');
                        $('#blackbirdButtons').removeClass('locked');
                        $('#bishopButtons').removeClass('locked');
                        $('#vanceButtons').removeClass('locked');
                        $('#arkamButtons').removeClass('locked');
                        $('#snargleButtons').removeClass('locked');
                    }
                    // unfaint portrait area
                    $('#gmArea').removeClass('fainter');

                    // update all role section with keys/secrets of active roles
                    var ar = '';
                    //console.log('active roles sent by server: ' + activeRoles.join(', '));
                    for (i = 0; i < activeRoles.length; i++) {
                        ar = activeRoles[i];

                        html = '';
                        if ((data.info != null) && (ar != "gm")) {
                            // traits
                            console.log('data.info[tags_' + ar + '] ' + data.info['tags_' + ar].length);
                            data.info['traits_' + ar].forEach(function(item) {
                                // get the tags under that trait
                                tagstr = data.info['tags_' + ar][item].join(', ');
                                html += '<div class="trait" title="' + tagstr + '">üé≠ ' + item + '</div>';
                            });
                            $('#traits' + ucFirstLetter(ar)).html(html);
                            html = '';
                            // keys
                            data.info['keys_' + ar].forEach(function(item) {
                                html += '<div class="key" title="' + infotext[item] + '">‚öø ' + item + '</div>';
                            });
                            $('#keys' + ucFirstLetter(ar)).html(html);
                            html = '';
                            // secrets
                            data.info['secrets_' + ar].forEach(function(item) {
                                html += '<div class="secret" title="' + infotext[item] + '">‚öù ' + item + '</div>';
                            });
                            $('#secrets' + ucFirstLetter(ar)).html(html);
                            // dice pool
                            dicepool[ar] = data.info['pool_' + ar]
                            html = '<span class="dicepool">‚öÑ ' + dicepool[ar] + '</span>';
                            $('#dicePool' + ucFirstLetter(ar)).html(html);
                            // xp
                            xp[ar] = data.info['xp_' + ar]
                            html = '<span class="xp">üè≤ ' + xp[ar] + '</span>';
                            $('#xp' + ucFirstLetter(ar)).html(html);

                            // active available pool dice for the formula dropdown menu
                            // doesn't work, because any "helping" will change this dropdown list
                            // $poolDice.empty();
                            // $poolDice.append('<option value="0" selected="selected">pool dice</option>');
                            //
                            // for (var j = 0; j < dicepool[ar]; j++) {
                            //     $poolDice.append('<option value="' + (j+1) + '">' + (j+1) + '</option>');
                            // }

                            // conditions
                            $('#injured' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['injured']);
                            $('#dead' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['dead']);
                            $('#tired' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['tired']);
                            $('#angry' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['angry']);
                            $('#lost' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['lost']);
                            $('#hunted' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['hunted']);
                            $('#trapped' + ucFirstLetter(ar)).prop('checked', data.info['conditions_' + ar]['trapped']);
                        }
                    }

                    // update other components
                    if (data.info != null) {
                        // difficulty
                        difficulty = data.info['difficulty'];
                        if (difficulty > 0) {
                            $('#difficulty').html('<span class="difficulty">vs. ' + difficulty + '</span>');
                        }
                        else {
                            $('#difficulty').html('');
                        }

                        // dice formula
                        console.log('dice formula action: ' + data.info['diceformula_a']);
                        $actionDice.val(data.info['diceformula_a']);
                        $poolDice.val(data.info['diceformula_p']);
                        $helpingDice.html(data.info['diceformula_h']);

                        // owl's condition
                        var owlc = data.info['owlconditions'];
                        $('#needFuel').prop('checked',owlc['fuel']);
                        $('#needSupplies').prop('checked',owlc['supplies']);
                        $('#needRepairs').prop('checked',owlc['repairs']);
                        $('#needSpeed').prop('checked',owlc['speed']);

                        portraits = data.info['portraits'];
                        updatePortraits();
                    }

                    html = activeRoles.length;
                    $totalRoles.html(html);

                } else {
                    //console.log('no active roles');
                    // enable all role buttons
                    for (var i = 0; i < $submitRoles.length; i++) {
                        $($submitRoles[i]).prop('disabled',false);
                    }
                }
            });

            socket.on('total connections', function(data) {
                var html = data.users;
                $totalConnections.html(html);
            });

            $('#owlConditions input[type=checkbox]').change(function() {
                var conditions = {
                    'fuel': $('#needFuel').prop('checked'),
                    'supplies': $('#needSupplies').prop('checked'),
                    'repairs': $('#needRepairs').prop('checked'),
                    'speed': $('#needSpeed').prop('checked')
                };
                socket.emit('condition update', {'role': 'owl', 'conditions': conditions});
            });

            $('#blackbirdConditions input[type=checkbox]').change(function() {
                var conditions = {
                    'injured': $('#injuredBlackbird').prop('checked'),
                    'dead': $('#deadBlackbird').prop('checked'),
                    'tired': $('#tiredBlackbird').prop('checked'),
                    'angry': $('#angryBlackbird').prop('checked'),
                    'lost': $('#lostBlackbird').prop('checked'),
                    'hunted': $('#huntedBlackbird').prop('checked'),
                    'trapped': $('#trappedBlackbird').prop('checked')
                };
                socket.emit('condition update', {'role': 'blackbird', 'conditions': conditions});
            });

            $('#bishopConditions input[type=checkbox]').change(function() {
                var conditions = {
                    'injured': $('#injuredBishop').prop('checked'),
                    'dead': $('#deadBishop').prop('checked'),
                    'tired': $('#tiredBishop').prop('checked'),
                    'angry': $('#angryBishop').prop('checked'),
                    'lost': $('#lostBishop').prop('checked'),
                    'hunted': $('#huntedBishop').prop('checked'),
                    'trapped': $('#trappedBishop').prop('checked')
                };
                socket.emit('condition update', {'role': 'bishop', 'conditions': conditions});
            });

            $('#vanceConditions input[type=checkbox]').change(function() {
                var conditions = {
                    'injured': $('#injuredVance').prop('checked'),
                    'dead': $('#deadVance').prop('checked'),
                    'tired': $('#tiredVance').prop('checked'),
                    'angry': $('#angryVance').prop('checked'),
                    'lost': $('#lostVance').prop('checked'),
                    'hunted': $('#huntedVance').prop('checked'),
                    'trapped': $('#trappedVance').prop('checked')
                };
                socket.emit('condition update', {'role': 'vance', 'conditions': conditions});
            });

            $('#arkamConditions input[type=checkbox]').change(function() {
                var conditions = {
                    'injured': $('#injuredArkam').prop('checked'),
                    'dead': $('#deadArkam').prop('checked'),
                    'tired': $('#tiredArkam').prop('checked'),
                    'angry': $('#angryArkam').prop('checked'),
                    'lost': $('#lostArkam').prop('checked'),
                    'hunted': $('#huntedArkam').prop('checked'),
                    'trapped': $('#trappedArkam').prop('checked')
                };
                socket.emit('condition update', {'role': 'arkam', 'conditions': conditions});
            });

            $('#snargleConditions input[type=checkbox]').change(function() {
                var conditions = {
                    'injured': $('#injuredSnargle').prop('checked'),
                    'dead': $('#deadSnargle').prop('checked'),
                    'tired': $('#tiredSnargle').prop('checked'),
                    'angry': $('#angrySnargle').prop('checked'),
                    'lost': $('#lostSnargle').prop('checked'),
                    'hunted': $('#huntedSnargle').prop('checked'),
                    'trapped': $('#trappedSnargle').prop('checked')
                };
                socket.emit('condition update', {'role': 'snargle', 'conditions': conditions});
            });

            $actionDice.on('change', function() {
                socket.emit('action dice update', $actionDice.val());
            });

            $poolDice.on('change', function() {
                // check if current pool has that many to be spent
                if (parseInt($poolDice.val()) <= dicepool[role]) {
                    socket.emit('pool dice update', $poolDice.val());
                }
                else {
                    // give it only the max the role has
                    socket.emit('pool dice update', dicepool[role]);
                    alert("you only have " + dicepool[role] + " dice to use");
                }
            });

            $diceForm.submit(function(e) {
                e.preventDefault();
                var command = 'lb';
                var a = $actionDice.val();
                var p = $poolDice.val();
                var h = $helpingDice.html();

                if (p == null) {
                    p = 0;
                }

                var dice = 1 + parseInt(a) + parseInt(p) + parseInt(h);
                command += dice;
                console.log('dice command: ' + command);

                p = parseInt(p);
                socket.emit('roll dice', {r: role, c: command, pd: p});
            });

            $messageForm.submit(function(e) {
                e.preventDefault();
                socket.emit('send message', $message.val());
                $message.val('');
            });

            socket.on('roll result', function(data) {
                $resultArea.html(data.result + '&nbsp;vs. ' + difficulty);
                // unlock helping button
                unlockHelping(data.role);
            });

            socket.on('new message', function(data) {
                var message = data.message;
                var type = data.type;
                var html = '';
                // if chat message was a dice command
                if (type == "rollresult") {
                    updateResult(message);
                    html += '<div class="well"><strong>' + data.role + '</strong> ( ' + message + ')</div>';
                    // unlock helping button
                    unlockHelping(data.role);
                }
                else if (type == "savegame") {
                    if ((data.role == role) && (data.role == "gm")) { // only GM can save game
                        var today = new Date();
                        var dd = String(today.getDate()).padStart(2, '0');
                        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                        var yyyy = today.getFullYear();

                        today = 'lb'+ yyyy + mm + dd;

                        // generate the file to download locally
                        download(today + ".json", message);
                    }

                    html += '<div class="well"><span style="color: gray;">' + data.role + ' is saving game data</span></div>';
                }
                else if (type == "loadgame") { // only GM can load game
                    $('#loadbox').show();
                }
                else if (type == "newgame") { // only GM can start new game
                    // read from default file
                    html += '<div class="well"><span style="color: gray;">' + data.role + ' started a new game</span></div>';
                }
                else if (type == "raisehand") {
                    updateResult('wait up');
                    html += '<div class="well text-success">(I want to say something!)</div>';
                }
                else if (type == "clear") {
                    updateResult('roll result');
                }
                else if (type == "x-card") {
                    // if chat message was related to X-card, hide who prompted it
                    html += '<div class="well">' + message + '</div>';
                    updateResult('time out');
                }
                else {
                    // regular chat message
                    html += '<div class="well"><strong>' + data.role + '</strong>: ' + message + '</div>';
                }
                updateChat(html);
            });

            function updateResult(html) {
                $resultArea.html(html);
            }

            function updateChat(html) {
                $chat.append(html);
                // scroll to bottom of chat window, of a dynamically-enlarging chat object
                $('#chatSection').scrollTop($chat.height());
            }

            socket.on('portrait url', function(data) {
                portraits = data;
                updatePortraits();
            });
        });

        function setDifficulty(n) {
            difficulty = n;
            socket.emit('set difficulty', n);
        }

        function refreshDicePools() {
            // refresh every role's dice pool back up to 7
            console.log('refresh');
            socket.emit('refresh dice pools');
        }

        function ucFirstLetter(str) {
            var result = str;
            if (result) {
                result = result.charAt(0).toUpperCase() + result.slice(1);
            }
            return result;
        }

        function updatePortraits() {
            var $roleForm = $('#roleForm');
            var r = '';
            var $submitRoles = $roleForm.find('input[type=submit]');
            var $e = null;

            for (var i = 0; i < $submitRoles.length; i++) {
                r = $submitRoles[i].name;
                if (r != "gm") {
                    $e = $('#portrait' + ucFirstLetter(r));
                    // hovering tooltip should show the image without distorted porportions
                    $e.attr('src', portraits[r]);
                    // force browser to use new image instead of cached image
                    $e.tooltip('dispose');
                    $e.tooltip({
                        html: true,
                        placement: 'right',
                        title: '<img src="' + portraits[r] + '" height="600" />'});
                }
            }
        }

        function portraitURL(name) {
            var url = prompt("paste in the URL of the image");
            if (url) {
                // try to check if image can be loaded
                var img = new Image();
                img.src = url;
                img.onload = function(){
                    portraits[name] = url;
                    // send info to server
                    socket.emit('portrait url', {'name': name, 'url': url});
                };
                img.onerror = function(){
                    alert("image cannot be loaded");
                }
            }
        }

        function dicePoolReward(name) {
            // only update if there is less than 10
            if (dicepool[name] < 10) {
                console.log(name + ' pool die reward');
                socket.emit('pool die reward', name);
            }
            else {
                alert("at most 10 dice per pool");
            }
        }

        function dicePoolHelping(name) {
            // help is only possible if there is dice in pool
            if (dicepool[name] > 0) {
                // add to helping part of the formula
                var total = parseInt($('#helpingDice').html());
                total += 1;
                $('#helpingDice').html(total);
                // lock the button to keeping helping at one die only
                $('#dicePool' + ucFirstLetter(name) + 'Helping').addClass('locked');

                socket.emit('pool die helping', {r: name, h: total});
            }
            else {
                alert("you don't have enough pool dice to help");
            }
        }

        function unlockHelping(name) {
            // name is the person who rolled the dice
            var $roleForm = $('#roleForm');
            var r = '';
            var $submitRoles = $roleForm.find('input[type=submit]');

            for (var i = 0; i < $submitRoles.length; i++) {
                r = $submitRoles[i].name;

                if ((r != "gm") && (r != name)) {
                    console.log('dice roller was ' + name + ' unlocking helping button for ' + r);
                    $('#dicePool' + ucFirstLetter(r) + 'Helping').removeClass('locked');
                }
            }
        }

        function xpReward(name) {
            socket.emit('xp reward', name);
        }

        function xpAdvance(name) {
            // only advance if there is enough to spend
            if (xp[name] > 4) {
                socket.emit('xp advance', name);
            }
            else {
                alert("not enough XP to advance yet");
            }
        }

        function bwContrastToggle() {
            var areas = ['blackbird','bishop','vance','arkam','snargle'];
            var darkRGB = "rgb(41, 43, 44)";
            var lightRGB = "rgb(220, 217, 205)";
            var colorRGB, bgRGB;
            var buttons;

            for (var i = 0; i < areas.length; i++) {
                var $area = $('#' + areas[i] + 'Area');
                // inverse the colors
                if ($area.css('color') == darkRGB) {; // if dark color text
                    colorRGB = lightRGB;
                    bgRGB = darkRGB;
                }
                else { // if light color text
                    colorRGB = darkRGB
                    bgRGB = lightRGB;
                }
                $area.css('color', colorRGB);
                $area.css('background-color', bgRGB);
                // lighten the button text
                buttons = $('#' + areas[i] + 'Area').find('[type=submit]');
                for (var j = 0; j < buttons.length; j++) {
                    $(buttons[j]).css('color', colorRGB);
                    $(buttons[j]).css('background-color', bgRGB);
                }
            }
        }

        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            // var element = document.getElementById(elmnt.id + "Header");
            // if (element) {
            //     // if present, the header is where you move the DIV from:
            //     element.onmousedown = dragMouseDown;
            // } else {
            //     // otherwise, move the DIV from anywhere inside the DIV:
            //     elmnt.onmousedown = dragMouseDown;
            // }
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = stopDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position, but never beyond broswer width or height
                var newtop = elmnt.offsetTop - pos2;
                var newleft = elmnt.offsetLeft - pos1;
                var size = {
                    width: window.innerWidth || document.body.clientWidth,
                    height: window.innerHeight || document.body.clientHeight
                }
                var width = e.srcElement.clientWidth;
                var height = e.srcElement.clientHeight;
                if (newtop < 0) {
                    newtop = 0;
                } else if ((newtop + height) > size.height) {
                    newtop = size.height - height;
                }
                if (newleft < 0) {
                    newleft = 0;
                } else if ((newleft + width) > size.width) {
                    newleft = size.width - width;
                }
                elmnt.style.top = newtop + "px";
                elmnt.style.left = newleft + "px";
            }

            function stopDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        $('#loadbox button[type=submit]').click(function(e) {
            e.preventDefault();
            socket.emit('load json', $('#loadboxjson').val());
            // hide the loadbox
            $('#loadbox').hide();
        });

        function showCharSheet(name) {
            var $charSheet = $('#charSheet');
            var $detail = $('#charSheetDetails');
            var html = '';
            var i;

            // rebuild all content based on current role's info

            html += '<div class="row">';
            html += '<div class="col">';
            var $traits = $('#traits' + ucFirstLetter(name));
            var traitlist = $traits.find('[class=trait]');
            for (i = 0; i < traitlist.length; i++) {
                html += $(traitlist[i]).html();
                html += '<div id="' + name + 'Tags" class="tags indented">';
                html += $(traitlist[i]).prop('title');
                html += '</div>';
            }
            html += '</div>';
            html += '<div class="col">';
            var $keys = $('#keys' + ucFirstLetter(name));
            var keylist = $keys.find('[class=key]');
            for (i = 0; i < keylist.length; i++) {
                html += $(keylist[i]).html();
                html += '<div class="keys indented">';
                html += $(keylist[i]).prop('title');
                html += '</div>';
            }
            var $secrets = $('#secrets' + ucFirstLetter(name));
            var secretlist = $secrets.find('[class=secret]');
            for (i = 0; i < secretlist.length; i++) {
                html += $(secretlist[i]).html();
                html += '<div class="secrets indented">';
                html += $(secretlist[i]).prop('title');
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';

            $detail.html(html);

            $charSheet.toggle();
        }

        function loreListToggle() {
            var $details = $('#lorelistDetails');
            var html = '';

            html += '<div class="row">';
            html += '<div class="col">';
            html += '<h3>Adrift in the Blue</h3>';
            html += 'The worlds of the Wild Blue float in a sky of breathable gases circling a small, cold star. Scholars believe that the star is made from pure Essence- the strange energy that sorcerers channel for their magic. This "solar system" is much smaller than you might think- it takes about six weeks to cross from one side to the other on a standard sky ship. Most of the worlds of the Empire are so closely positioned that it takes only a day or two to travel from one to another.';
            html += '<br/>';
            html += '<h3>The Lower Depths</h3>';
            html += 'The heavier gases form a dense layer of fog below the "sky" of the Wild Blue. This fog is corrosive - people need to wear gas-masks to breathe and most airship hulls will start to corrode after a single exposure. Pirates and other criminals sometimes use the lower depths to evade Imperial patrols and launch raids from hiding. Unfortunately, the depths are home to sky squid and other monstrous things...';
            html += '<br/>';
            html += '<h3>Names</h3>';
            html += '<b>Male</b>: Abel, Artemis, August, Eli, Giovanni, Ivan, Jack, Jefferson, Jonas, Leo, Logan, Malachi, Mario, Micah, Nahum, Noah, Orlence, Oscar, Samuel, Silas, Victor, Vlad, Wester';
            html += '<br/>';
            html += '<b>Female</b>: Alice, Ardent, Ashlyn, Caess, Clare, Elena, Eveline, Fiona, Grace, Hannah, Hazel, Hester, Isabel, Krista, Jezebel, Leah, Lucile, Lydia, Seraphina, Sonya, Sophie, Veronica, Violet';
            html += '<br/>';
            html += '<b>Surnames</b>: Bell, Bowen, Canter, Carson, Cross, Harwood, Hollas, Hunter, Kalra, Keel, Moreau, Morgan, Porter, Pickett, Quinn, Sidhu, Soto, Torrez, Vakharia, Walker, Winter, Wright';
            html += '<br/>';
            html += '<b>Noble Houses</b>: Ash, Blackbird, Firefly, Mooncloud, Nightsong, Snow, Twilight, Whitethorn.';

            html += '</div><div class="col">';

            html += '<h3>Ilysium</h3>';
            html += 'The capitol world of the Empire, home to the great noble houses. Ilysium is rich and decadent, attended by servants, slaves, and the elite bodyguards of the nobility.';
            html += '<br/>';
            html += '<h3>Olympia</h3>';
            html += 'The staging world of the Imperial Sky Fleet. From here, expeditions are launched into the colonial expanse and all across the Wild Blue. Olympia is also home to the finest brewers and distillers in the Empire.';
            html += '<h3>Haven</h3>';
            html += 'The most prominent of the Free Worlds. Here, in the sprawling city hubs, the Trade Union tries to impose some order on the bickering clans and factions of the Free Peoples. Slavery is outlawed here, so many ex-slaves make Haven their home.';
            html += '<h3>Nightport</h3>';
            html += 'Unlike other worlds, Nightport does not rotate, which means one face is always in darkness. It is on this side that pirates and smugglers have built a hidden port city in which to carry out their nefarious dealings. This hive of scum and villainy is a dangerous place, but almost anything may be bought or sold there, including secrets.';
            html += '<h3>The Remnants</h3>';
            html += "A swirling maelstrom of spinning world-shards. The Remnants are almost impossible to navigate, even for the best airship pilots. It's said that the pirate king, Uriah Flint, keeps his secret fortress somewhere deep within the Remnants and only those who know the secret of the true course can ever reach it.";
            html += '</div></div>';

            $details.html(html);
            $('#lorelist').toggle();
        }

        function raiseHand() {
            socket.emit('send message', 'RAISE HAND');
        }

        function xcard() {
            var msg = prompt("what content to remove?");
            if (msg !== null) {
                socket.emit('send message', 'X-Card: ' + msg);
            }
        }

        function clearResultArea() {
            socket.emit('send message', 'CLEAR');
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
    </script>
</body>
</html>
